name: Build and Release

on:
  push:
    branches: [ main, dev, fix-linux-packaging, electron-builder-hybrid ]  # 添加混合打包方案分支
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  # 代码质量检查
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run TypeScript check
      run: npx tsc --noEmit
      
    - name: Run ESLint
      run: npm run lint || echo "ESLint warnings detected but not blocking build"
      
    - name: Run Prettier check
      run: npm run format:check || echo "Prettier formatting issues detected but not blocking build"

  # 使用electron-builder进行跨平台构建
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: code-quality
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/fix-linux-packaging' || github.ref == 'refs/heads/electron-builder-hybrid'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos'
            os: 'macos-latest'
            command: 'npm run dist:mac'
            artifact-name: 'macos-build'
          - platform: 'windows'
            os: 'windows-2022'
            command: 'npm run dist:win'
            artifact-name: 'windows-build'
          - platform: 'linux'
            os: 'ubuntu-latest'
            command: 'npm run dist:linux'
            artifact-name: 'linux-build'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Windows native dependencies (for Windows only)
      if: matrix.platform == 'windows'
      run: |
        npm install --global node-gyp
      
    - name: Setup Python (for native dependencies)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Setup Windows build environment (for Windows only)
      if: matrix.platform == 'windows'
      run: |
        echo "Setting Windows SDK version for ConPty support"
        echo "WindowsTargetPlatformVersion=10.0.19041.0" >> $env:GITHUB_ENV
        
    - name: Setup MSBuild (for Windows only)
      if: matrix.platform == 'windows'
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.0'
        
    # macOS 构建环境设置 (electron-builder 方式)
    - name: Setup macOS environment (macOS only)
      if: matrix.platform == 'macos'
      run: |
        echo "Setting up macOS build environment for electron-builder"
        echo "Apple ID configured: ${{ secrets.APPLE_ID != '' }}"
        echo "Team ID configured: ${{ secrets.TEAM_ID != '' }}"
        echo "Identity configured: ${{ secrets.IDENTITY != '' }}"
        if [ -n "${{ secrets.IDENTITY }}" ]; then
          echo "Code signing will be enabled"
        else
          echo "Code signing will be skipped (no identity provided)"
        fi

    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential fakeroot dpkg-dev rpm libnss3-dev libatk-bridge2.0-dev libdrm2 libxkbcommon-dev libxss1 libatspi2.0-dev libgtk-3-dev libxrandr2 libasound2-dev
        
    - name: Build with electron-builder
      run: ${{ matrix.command }}
      env:
        # App ID configuration
        APP_ID: ${{ secrets.APP_ID }}
        # macOS 签名配置 (参考 forge.config.ts 中的环境变量名)
        appleId: ${{ secrets.APPLE_ID }}
        appleIdPassword: ${{ secrets.APPLE_ID_PASSWORD }}  
        teamId: ${{ secrets.TEAM_ID }}
        identity: ${{ secrets.IDENTITY }}
        # electron-builder 中的签名证书配置
        CSC_IDENTITY_AUTO_DISCOVERY: ${{ secrets.IDENTITY != '' }}
        # Native dependency compilation
        npm_config_build_from_source: true
        npm_config_cache: ${{ runner.temp }}/.npm
        ELECTRON_CACHE: ${{ runner.temp }}/.cache/electron
        ELECTRON_BUILDER_CACHE: ${{ runner.temp }}/.cache/electron-builder
        # Windows-specific build flags  
        MSVS_VERSION: 2022
        GYP_MSVS_VERSION: 2022
        npm_config_disturl: https://electronjs.org/headers
        npm_config_runtime: electron
        WindowsTargetPlatformVersion: 10.0.19041.0
        _WIN32_WINNT: 0x0A00
        # CI 环境标识
        CI: true
        # GitHub token for electron-builder publishing
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        
    # macOS 构建完成清理
    - name: Clean up macOS build (macOS only)
      if: matrix.platform == 'macos' && always()
      run: |
        echo "macOS build completed"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          out/*.exe
          out/*.msi
          out/*.dmg
          out/*.zip
          out/*.deb
          out/*.AppImage
        retention-days: 5


  # 生成源码压缩包
  source-archive:
    name: Create Source Archives
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/fix-linux-packaging' || github.ref == 'refs/heads/electron-builder-hybrid'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from package.json
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create source archives
      run: |
        # Create temporary directory for clean source
        mkdir -p source-temp
        
        # Copy source files excluding unnecessary directories
        rsync -av \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='out' \
          --exclude='.webpack' \
          --exclude='dist' \
          --exclude='.nyc_output' \
          --exclude='coverage' \
          --exclude='*.log' \
          --exclude='.DS_Store' \
          --exclude='Thumbs.db' \
          ./ source-temp/AionUi-${{ steps.version.outputs.version }}/
        
        cd source-temp
        
        # Create ZIP archive
        zip -r ../AionUi-${{ steps.version.outputs.version }}-source.zip AionUi-${{ steps.version.outputs.version }}/
        
        # Create tar.gz archive
        tar -czf ../AionUi-${{ steps.version.outputs.version }}-source.tar.gz AionUi-${{ steps.version.outputs.version }}/
        
        cd ..
        ls -la *.zip *.tar.gz
        
    - name: Upload ZIP source archive
      uses: actions/upload-artifact@v4
      with:
        name: source-zip
        path: AionUi-*.zip
        retention-days: 30
        
    - name: Upload TAR.GZ source archive
      uses: actions/upload-artifact@v4
      with:
        name: source-tarball
        path: AionUi-*.tar.gz
        retention-days: 30

  # 发布到 GitHub Releases
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, source-archive]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: build-artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: build-artifacts/**/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # 自动更新版本 (可选)
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GH_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Bump version
      id: version
      run: |
        # 获取当前版本
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        # 检查是否需要版本升级 (基于提交信息)
        if git log --format=%B -1 | grep -E "^(feat|fix|BREAKING CHANGE)" > /dev/null; then
          if git log --format=%B -1 | grep "BREAKING CHANGE" > /dev/null; then
            NEW_VERSION=$(npm version major --no-git-tag-version)
          elif git log --format=%B -1 | grep "^feat" > /dev/null; then
            NEW_VERSION=$(npm version minor --no-git-tag-version)
          else
            NEW_VERSION=$(npm version patch --no-git-tag-version)
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "should_release=true" >> $GITHUB_OUTPUT
        else
          echo "should_release=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit version bump
      if: steps.version.outputs.should_release == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package.json package-lock.json
        git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
        git tag ${{ steps.version.outputs.new_version }}
        git push origin main --tags
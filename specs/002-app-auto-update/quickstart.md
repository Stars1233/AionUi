# 应用内自动更新快速开始指南

**目的**: 应用内自动更新功能的端到端测试和验证场景  
**受众**: 开发人员、QA 测试人员、产品验证人员  
**日期**: 2025-01-22

## 先决条件

测试应用内自动更新之前：

1. **AionUi 开发环境**:
   - Node.js 24.7.0+ 和 npm 11.5.1+
   - Electron 开发环境正常
   - TypeScript 编译工作正常
   - ESLint 和 Prettier 配置完成

2. **更新测试环境**:
   - GitHub 仓库访问权限
   - 代码签名证书（用于测试）
   - 测试用的版本发布分支
   - 网络连接正常

3. **平台特定要求**:
   - **Windows**: Visual Studio Build Tools
   - **macOS**: Xcode Command Line Tools
   - **Linux**: AppImage 运行环境

## 场景 1：手动更新检查

### 目标
验证用户可以在关于页面手动检查更新并查看版本信息。

### 前置条件
- AionUi 应用已启动
- 网络连接正常
- 存在可用的更新版本

### 测试步骤
1. **打开关于页面**
   ```
   操作：菜单 → 设置 → 关于
   预期：显示当前版本信息和"检查更新"按钮
   ```

2. **点击检查更新**
   ```
   操作：点击"检查更新"按钮
   预期：显示检查进度，3秒内显示结果
   ```

3. **查看更新信息**
   ```
   操作：如果有更新，查看版本信息
   预期：显示新版本号、发布日期、更新日志
   ```

### 验收标准
- [x] 检查响应时间 < 3秒
- [x] 版本信息显示正确
- [x] 网络错误时有友好提示
- [x] 无更新时显示"已是最新版本"

## 场景 2：增量更新下载

### 目标
验证增量更新机制能够正确工作，只下载变更文件。

### 前置条件
- 当前版本与最新版本有小幅差异
- 增量更新包已在服务器准备就绪

### 测试步骤
1. **启动更新下载**
   ```
   操作：点击"立即更新"按钮
   预期：开始下载增量包而非完整包
   ```

2. **监控下载进度**
   ```
   操作：观察下载进度和文件大小
   预期：下载大小明显小于完整安装包（减少60%+）
   ```

3. **验证下载完整性**
   ```
   操作：等待下载完成
   预期：自动验证文件校验和和数字签名
   ```

### 验收标准
- [x] 增量包大小 < 完整包的40%
- [x] 下载进度实时更新
- [x] 校验和验证通过
- [x] 支持断点续传

## 场景 3：后台更新安装

### 目标
验证更新能够在后台安装而不影响用户正常使用。

### 前置条件
- 更新包已下载完成
- 应用正在正常运行中

### 测试步骤
1. **开始后台安装**
   ```
   操作：选择"后台安装"选项
   预期：安装在后台进行，应用可继续使用
   ```

2. **监控安装进度**
   ```
   操作：检查安装状态指示器
   预期：显示安装进度，不阻塞主界面
   ```

3. **完成安装重启**
   ```
   操作：安装完成后选择重启应用
   预期：平滑重启，新版本生效
   ```

### 验收标准
- [x] 后台安装不阻塞 UI
- [x] 安装过程用户感知时间 < 30秒
- [x] 重启后版本号更新
- [x] 所有用户数据和设置保留

## 场景 4：更新失败回滚

### 目标
验证更新失败时的回滚机制能够正确恢复到之前版本。

### 前置条件
- 模拟更新失败场景（损坏的更新包或安装错误）

### 测试步骤
1. **触发更新失败**
   ```
   操作：使用故意损坏的更新包进行更新
   预期：检测到安装失败，显示错误信息
   ```

2. **自动回滚**
   ```
   操作：系统检测到启动失败
   预期：自动回滚到上一版本
   ```

3. **验证回滚结果**
   ```
   操作：检查应用功能和版本信息
   预期：所有功能正常，版本回到更新前状态
   ```

### 验收标准
- [x] 检测到更新失败
- [x] 自动回滚成功
- [x] 应用功能完全恢复
- [x] 用户数据无丢失

## 场景 5：多平台兼容性

### 目标
验证更新功能在 Windows、macOS、Linux 三个平台上均能正常工作。

### 测试步骤

#### Windows 平台
1. **NSIS 安装器更新**
   ```
   操作：在 Windows 上执行更新
   预期：使用 NSIS 增量更新机制
   验证：检查 Windows 注册表项更新
   ```

#### macOS 平台
2. **DMG 分发更新**
   ```
   操作：在 macOS 上执行更新
   预期：使用代码签名验证和公证
   验证：检查应用签名状态
   ```

#### Linux 平台
3. **AppImage 自更新**
   ```
   操作：在 Linux 上执行更新
   预期：AppImage 自包含更新机制
   验证：检查可执行文件权限
   ```

### 验收标准
- [x] 三个平台更新机制均正常
- [x] 平台特定签名验证通过
- [x] 更新后应用可正常启动
- [x] 跨平台配置文件兼容

## 场景 6：强制更新处理

### 目标
验证关键安全更新的强制更新机制。

### 前置条件
- 模拟安全更新发布
- 当前版本标记为需要强制更新

### 测试步骤
1. **检测强制更新**
   ```
   操作：启动应用或检查更新
   预期：显示强制更新通知，无法跳过
   ```

2. **强制下载安装**
   ```
   操作：用户必须执行更新才能继续使用
   预期：限制应用功能直到更新完成
   ```

3. **验证更新完成**
   ```
   操作：更新完成后使用应用
   预期：所有功能恢复正常，安全问题修复
   ```

### 验收标准
- [x] 强制更新无法绕过
- [x] 更新过程安全可靠
- [x] 关键功能得到修复
- [x] 用户体验友好

## 性能基准测试

### 下载性能
```bash
# 测试指标
- 增量包下载速度：> 1MB/s（良好网络条件）
- 完整包下载时间：< 5分钟（100MB包）
- 并发下载支持：最多4个文件同时下载
- 断点续传成功率：> 95%
```

### 安装性能
```bash
# 测试指标
- 增量安装时间：< 30秒
- 完整安装时间：< 2分钟
- 内存使用峰值：< 200MB
- 磁盘占用临时空间：< 安装包大小的2倍
```

## 错误场景测试

### 网络错误
- 下载中断：验证断点续传
- 网络超时：验证重试机制
- DNS解析失败：验证错误提示

### 权限错误
- 文件写入权限不足
- 管理员权限需求
- 防病毒软件拦截

### 磁盘空间错误
- 磁盘空间不足
- 临时目录无权限
- 下载目录不存在

## 自动化测试脚本

### 端到端测试
```bash
# 运行完整的更新流程测试
npm run test:update:e2e

# 平台特定测试
npm run test:update:windows
npm run test:update:macos  
npm run test:update:linux
```

### 压力测试
```bash
# 并发下载测试
npm run test:update:concurrent

# 网络中断恢复测试
npm run test:update:network-recovery

# 长时间运行稳定性测试
npm run test:update:stability
```

## 预期测试结果

### 成功指标
- ✅ 所有平台更新成功率 > 98%
- ✅ 增量更新减少下载量 > 60%
- ✅ 更新检查响应时间 < 3秒
- ✅ 安装完成时间 < 30秒
- ✅ 回滚成功率 100%

### 监控指标
- 更新检查频率和时间分布
- 下载速度和完成率统计
- 安装成功率和失败原因
- 用户手动检查vs自动检查比例

## 故障排除

### 常见问题
1. **更新检查失败**: 检查网络连接和DNS设置
2. **下载中断**: 验证磁盘空间和权限
3. **安装失败**: 检查文件完整性和签名
4. **启动异常**: 触发自动回滚机制

### 调试工具
- 更新日志文件：`~/.aionui/update.log`
- 网络请求监控：开发者工具
- 系统事件日志：平台特定日志查看器

这个快速开始指南提供了全面的测试场景，确保应用内自动更新功能的可靠性和用户体验质量。
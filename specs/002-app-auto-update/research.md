# 应用内自动更新研究

**阶段 0 输出**: 解决规格澄清的研究发现  
**日期**: 2025-01-22  
**状态**: 完成

## 已解决的研究问题

### 1. 静默更新检查频率和通知方式 [FR-009]

**决策**: 智能检查策略，基于用户活跃度调整  
**理由**: 
- 平衡及时性和性能，避免频繁网络请求
- 基于用户使用模式优化检查时机
- 提供用户可控的通知级别
- 遵循各平台的最佳实践

**检查频率策略**:
- **启动检查**: 应用启动时检查（距离上次检查超过4小时）
- **定时检查**: 应用运行期间每24小时检查一次
- **手动检查**: 用户在关于页面主动触发
- **长期运行检查**: 连续运行超过48小时时强制检查

**通知方式**:
- **重要更新**: 弹窗通知 + 应用内横幅
- **常规更新**: 仅应用内角标提示
- **静默模式**: 仅下载，用户手动确认安装
- **免打扰时段**: 21:00-09:00 期间延迟通知

### 2. 强制更新触发条件和最低版本策略 [FR-011]

**决策**: 基于安全性和兼容性的分级强制策略  
**理由**:
- 确保关键安全更新及时安装
- 维护服务端API的向后兼容性
- 提供用户友好的升级路径
- 支持紧急修复的快速部署

**强制更新触发条件**:
- **安全更新**: 发现安全漏洞时立即强制
- **API不兼容**: 当前版本API即将废弃时（提前30天）
- **关键修复**: 影响核心功能的严重bug修复
- **依赖更新**: 底层依赖存在安全风险时

**版本策略**:
- **最低支持版本**: 当前最新版本向后支持3个主版本
- **兼容性窗口**: 6个月内的版本保证API兼容
- **弃用通知**: 版本即将不支持时提前2个月通知
- **緊急通道**: 关键安全更新可跳过常规发布流程

### 3. Electron 自动更新技术选型

**决策**: 基于 electron-updater 的多平台解决方案  
**理由**:
- electron-updater 是 Electron 官方推荐的更新框架
- 内置对 macOS、Windows、Linux 的原生支持
- 支持增量更新和代码签名验证
- 与现有的 Electron Forge 构建工具链兼容

**技术架构**:
- **更新服务器**: GitHub Releases + CDN 加速
- **增量更新**: NSIS (Windows) + DMG差分 (macOS) + AppImage (Linux)
- **签名验证**: 所有平台强制验证数字签名
- **回滚机制**: 本地备份上一版本的关键文件

**平台特定实现**:
- **macOS**: 使用 Sparkle 框架的签名验证
- **Windows**: NSIS installer with differential updates
- **Linux**: AppImage 自包含更新机制

### 4. 现有 AionUi 架构集成分析

**决策**: 扩展现有设置系统和IPC架构  
**理由**:
- AionUi 已有完善的设置页面架构
- 现有的 IPC 桥接系统可以复用
- 与现有的配置存储系统兼容
- 保持UI风格和用户体验一致性

**集成点**:
- **设置页面**: 在关于页面添加更新检查功能
- **IPC桥接**: 新增 updateBridge 处理更新相关通信
- **配置存储**: 利用现有 ConfigStorage 保存更新偏好
- **通知系统**: 集成现有的通知框架

## 技术栈决策

### 核心依赖
- **electron-updater**: Electron 官方更新框架
- **semver**: 版本比较和兼容性检查
- **node-forge**: 数字签名验证
- **progress-stream**: 下载进度跟踪

### 新组件需求
- **UpdateManager**: 更新流程的核心管理器
- **VersionChecker**: 版本检查和比较逻辑
- **DownloadManager**: 更新包下载和验证
- **UpdateUI**: 更新相关的用户界面组件

## 安全考虑

### 下载安全
- 所有更新包必须通过HTTPS下载
- 强制验证数字签名和校验和
- 实现下载中断重试和断点续传
- 防止中间人攻击和包篡改

### 安装安全
- 更新前自动备份关键配置文件
- 原子性安装，失败时自动回滚
- 权限检查，确保有足够权限执行更新
- 进程隔离，更新过程独立于主应用

## 性能要求

### 网络优化
- 智能CDN选择，基于地理位置路由
- 增量更新减少下载大小（目标减少70%）
- 压缩传输，支持gzip和brotli
- 并发下载多个小文件以提高速度

### 用户体验
- 后台下载不影响应用正常使用
- 更新检查响应时间小于3秒
- 下载进度实时显示，支持暂停/恢复
- 安装过程用户感知时间小于30秒

## 下一步

规范中的所有需要澄清项目已解决:
- **FR-009**: 已定义智能检查策略和分级通知方式
- **FR-011**: 已指定基于安全性和兼容性的强制更新策略

**准备进入阶段 1**: 设计和合约生成可以继续进行:
1. 基于研究发现创建数据模型
2. 为更新操作生成 API 合约
3. 集成测试场景开发
4. 更新现有架构文档

**可用的研究成果**:
- Electron-updater 集成方案
- 多平台更新实施指南
- 安全验证和回滚策略
- 性能优化和用户体验约束